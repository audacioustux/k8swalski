name: Update README

on:
  push:
    branches: [main]
    paths: ['src/config.rs', 'src/main.rs', 'Cargo.toml']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Rust Environment
        uses: ./.github/actions/setup-rust-env
      
      - name: Generate CLI help
        id: help
        run: |
          HELP_OUTPUT=$(nix develop --command cargo run --quiet -- --help)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$HELP_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs').promises;
            const helpOutput = `${{ steps.help.outputs.content }}`;
            
            const README_FILE = 'README.md';
            const BEGIN_MARKER = '<!-- BEGIN_CLI_HELP -->';
            const END_MARKER = '<!-- END_CLI_HELP -->';
            
            const readmeContent = await fs.readFile(README_FILE, 'utf8');
            const beginIndex = readmeContent.indexOf(BEGIN_MARKER);
            const endIndex = readmeContent.indexOf(END_MARKER);
            
            if (beginIndex === -1 || endIndex === -1) {
              throw new Error('Markers not found in README.md');
            }
            
            const beforeMarker = readmeContent.substring(0, beginIndex + BEGIN_MARKER.length);
            const afterMarker = readmeContent.substring(endIndex);
            const block = (content) => '```\n' + content + '\n```';
            const updatedContent = beforeMarker + '\n' + block(helpOutput) + '\n' + afterMarker;
            
            await fs.writeFile(README_FILE, updatedContent, 'utf8');
            console.log('README.md updated successfully');
      
      - name: Commit changes
        run: |
          git diff --exit-code README.md && exit 0
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update CLI help [skip ci]"
          git push
